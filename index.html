<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å‹é“¾çŠ¶æ€å¯è§†åŒ–</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* æ·¡è‰²ä¸»é¢˜èƒŒæ™¯ */
  body { 
    background: linear-gradient(to bottom, #f9fafb, #f3f4f6); 
    transition: background 0.3s, color 0.3s; 
    color: #1f2937;
    min-height: 100vh;
  }

  /* æ·±è‰²ä¸»é¢˜èƒŒæ™¯ */
  body.dark { 
    background: linear-gradient(to bottom, #1f2937, #111827); 
    color: #f9fafb;
  }

  /* é¡¶éƒ¨æ¸å˜ */
  .header-bg {
    background: linear-gradient(90deg, #3b82f6, #06b6d4);
    color: white;
    padding: 2rem 1rem;
    border-radius: 1rem;
    text-align: center;
    margin-bottom: 2rem;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    transition: background 0.3s;
  }
  body.dark .header-bg { 
    background: linear-gradient(90deg, #2563eb, #0ea5e9); 
  }

  /* å…¥åœºåŠ¨ç”» */
  .card, .stat-card, .glass-card {
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(20px);
    cursor: default;
  }
  .card.show, .stat-card.show, .glass-card.show { 
    opacity: 1; 
    transform: translateY(0); 
  }

  /* å¡ç‰‡æ‚¬åœæ•ˆæœ */
  .hover-animate:hover { 
    filter: brightness(1.1);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }

  /* ä¸å¯è¾¾çŠ¶æ€ */
  .unreachable { 
    filter: grayscale(80%); 
    opacity: 0.8; 
    border: 1px solid #fca5a5 !important; 
  }
  body.dark .unreachable {
    border: 1px solid #7f1d1d !important;
  }

  /* ç»Ÿè®¡å¡ç‰‡æ¸å˜ */
  .stat-green { background: linear-gradient(135deg, #d1fae5, #10b981); }
  .stat-red { background: linear-gradient(135deg, #fee2e2, #ef4444); }
  .stat-blue { background: linear-gradient(135deg, #dbeafe, #3b82f6); }
  .stat-card:hover { filter: brightness(1.15); }

  /* æ¯›ç»ç’ƒæ•ˆæœå¡ç‰‡ - æ—¥é—´æ¨¡å¼æ”¹ä¸ºç²‰è‰² */
  .glass-card {
    background: rgba(255, 228, 230, 0.6) !important; /* æ·¡ç²‰è‰² */
    backdrop-filter: blur(16px) saturate(200%);
    -webkit-backdrop-filter: blur(16px) saturate(200%);
    border: 1px solid rgba(255, 228, 230, 0.4);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }
  body.dark .glass-card {
    background: rgba(31, 41, 55, 0.6) !important;
    border: 1px solid rgba(255, 255, 255, 0.15);
  }

  /* ä¸å¯è¾¾å¡ç‰‡ç‰¹æ®Šæ ·å¼ */
  .glass-card.unreachable {
    background: rgba(254, 226, 226, 0.5) !important;
  }
  body.dark .glass-card.unreachable {
    background: rgba(127, 29, 29, 0.4) !important;
  }

  /* åç§°é¢œè‰²æ§åˆ¶ */
  .name-display {
    color: #1f2937; /* æ—¥é—´é»‘è‰² */
  }
  body.dark .name-display {
    color: white; /* å¤œé—´ç™½è‰² */
  }

  /* å¤œé—´æ¨¡å¼æŒ‰é’® */
  #dark-toggle {
    position: fixed; 
    bottom: 20px; 
    right: 20px;
    background: #3b82f6; 
    color: white;
    width: 50px; 
    height: 50px; 
    border-radius: 50%;
    display: flex; 
    justify-content: center; 
    align-items: center;
    font-size: 1.5rem; 
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    z-index: 1000;
  }
  #dark-toggle:hover { 
    transform: scale(1.1); 
  }
  body.dark #dark-toggle { 
    background: #0ea5e9; 
  }

  /* ç¡®ä¿ç»Ÿè®¡å¡ç‰‡æ–‡å­—å§‹ç»ˆä¸ºç™½è‰² */
  .stat-card, .stat-card * {
    color: white !important;
  }

  /* å›¾è¡¨å®¹å™¨æ ·å¼ */
  .chart-wrapper {
    background-color: white;
    border-radius: 0.75rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    padding: 1rem;
    margin-bottom: 2rem;
    height: 400px;
    position: relative;
  }
  body.dark .chart-wrapper {
    background-color: #1f2937;
  }

  /* å›¾è¡¨æ ‡é¢˜æ ·å¼ */
  .chart-title {
    color: #1f2937;
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  body.dark .chart-title {
    color: white;
  }

  /* ç¡®ä¿canvaså…ƒç´ å¡«æ»¡å®¹å™¨ */
  .chart-wrapper canvas {
    width: 100% !important;
    height: calc(100% - 30px) !important;
  }

  /* é•¿åç§°å¤„ç† */
  .truncate-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 180px;
    display: inline-block;
  }
</style>
</head>
<body class="text-gray-800">
<div class="max-w-6xl mx-auto py-8 px-4">

  <!-- é¡¶éƒ¨ -->
  <div class="header-bg">
    <h1 class="text-4xl font-bold mb-1">ğŸ“Š å‹é“¾çŠ¶æ€å¯è§†åŒ–</h1>
    <p id="last-updated" class="text-sm opacity-90">æœ€åæ›´æ–°æ—¶é—´ï¼šåŠ è½½ä¸­...</p>
  </div>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <div id="summary" class="grid grid-cols-3 gap-4 mb-8 text-center"></div>

  <!-- å»¶è¿Ÿå›¾è¡¨ -->
  <div class="chart-wrapper transition-colors">
    <h2 class="chart-title">ğŸ“¶ å»¶è¿Ÿç»Ÿè®¡</h2>
    <canvas id="latencyChart"></canvas>
  </div>

  <!-- é“¾æ¥åˆ—è¡¨ -->
  <div id="link-list" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>
</div>

<!-- å¤œé—´æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
<div id="dark-toggle" title="åˆ‡æ¢å¤œé—´æ¨¡å¼">ğŸŒ™</div>

<script>
  // å¤œé—´æ¨¡å¼åˆ‡æ¢
  const toggle = document.getElementById("dark-toggle");
  toggle.addEventListener("click", ()=>{
    document.body.classList.toggle("dark");
    updateChartColors();
  });

  // æ™ºèƒ½åç§°æˆªæ–­å‡½æ•°
  function truncateName(name, maxLength = 12) {
    if (name.length <= maxLength) return name;
    const halfLength = Math.floor(maxLength / 2) - 1;
    return name.substring(0, halfLength) + '...' + name.substring(name.length - halfLength);
  }

  // å›¾è¡¨æ ‡ç­¾æˆªæ–­å‡½æ•°
  function truncateChartLabel(name, maxLength = 8) {
    if (name.length <= maxLength) return name;
    return name.substring(0, maxLength - 1) + 'â€¦';
  }

  async function loadData() {
    try {
      const res = await fetch("./result.json");
      const data = await res.json();

      document.getElementById("last-updated").innerText = "æœ€åæ›´æ–°æ—¶é—´ï¼š" + data.timestamp;

      const inaccessibleCount = data.link_status.filter(link => link.latency < 0).length;
      const accessibleCount = data.link_status.length - inaccessibleCount;
      const totalCount = data.link_status.length;

      // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
      document.getElementById("summary").innerHTML = `
        <div class="stat-card stat-green rounded-xl p-6 shadow hover-animate show">
          <div class="text-3xl font-bold">${accessibleCount}</div>
          <div class="mt-1">å¯è®¿é—®</div>
        </div>
        <div class="stat-card stat-red rounded-xl p-6 shadow hover-animate show">
          <div class="text-3xl font-bold">${inaccessibleCount}</div>
          <div class="mt-1">ä¸å¯è®¿é—®</div>
        </div>
        <div class="stat-card stat-blue rounded-xl p-6 shadow hover-animate show">
          <div class="text-3xl font-bold">${totalCount}</div>
          <div class="mt-1">æ€»æ•°</div>
        </div>
      `;

      // å»¶è¿Ÿå›¾è¡¨
      const ctx = document.getElementById('latencyChart').getContext('2d');
      const labels = data.link_status.map(link => link.name);
      const values = data.link_status.map(link => link.latency >= 0 ? link.latency : 0);
      const colors = data.link_status.map(link => link.latency >= 0 ? 'rgba(37,99,235,0.7)' : 'rgba(220,38,38,0.4)');

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'å»¶è¿Ÿ (ç§’)',
            data: values,
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace('0.4','1').replace('0.7','1')),
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { 
            y: { 
              beginAtZero: true, 
              title: { 
                display: true, 
                text: 'ç§’',
                color: '#1f2937'
              },
              ticks: {
                color: '#1f2937',
                maxTicksLimit: 6
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#1f2937',
                maxRotation: 45,
                minRotation: 45,
                callback: function(value) {
                  return truncateChartLabel(this.getLabelForValue(value));
                }
              },
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              labels: {
                color: '#1f2937',
                usePointStyle: true,
                padding: 20
              }
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  return data.link_status[context[0].dataIndex].name;
                },
                label: function(context) {
                  const link = data.link_status[context.dataIndex];
                  return `å»¶è¿Ÿ: ${link.latency >= 0 ? link.latency.toFixed(2) + 's' : 'ä¸å¯è¾¾'}`;
                }
              }
            }
          }
        }
      });

      // æ¸²æŸ“å‹é“¾å¡ç‰‡ï¼ˆä½¿ç”¨ç²‰è‰²æ¯›ç»ç’ƒæ•ˆæœï¼‰
      const linkList = document.getElementById("link-list");
      linkList.innerHTML = data.link_status.map((link,i) => `
        <div class="glass-card ${link.latency<0?'unreachable':''} hover-animate delay-${i+1} rounded-xl p-5 flex flex-col items-center text-center">
          <img src="${link.avatar}" class="w-20 h-20 rounded-full border-2 border-white/30 mb-3" onerror="this.src='https://via.placeholder.com/64?text=?'">
          <div class="name-display text-lg font-semibold mb-1 truncate-name" title="${link.name}">
            ${truncateName(link.name)}
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">${link.descr}</p>
          <p class="text-xs">
            å»¶è¿Ÿ: ${link.latency>=0?`<span class="text-green-600 font-mono">${link.latency.toFixed(2)}s</span>`:`<span class="text-red-600">ä¸å¯è¾¾</span>`}
          </p>
        </div>
      `).join("");

      // å¡ç‰‡å…¥åœºåŠ¨ç”»
      document.querySelectorAll(".glass-card").forEach((el,i)=>{
        setTimeout(()=>el.classList.add("show"), i*80);
      });

      // åˆå§‹æ›´æ–°å›¾è¡¨é¢œè‰²
      updateChartColors();

    } catch(err) {
      document.getElementById("link-list").innerHTML = `<div class="text-red-600 text-center">âŒ åŠ è½½å¤±è´¥: ${err.message}</div>`;
    }
  }

  // æ›´æ–°å›¾è¡¨é¢œè‰²å‡½æ•°
  function updateChartColors() {
    const isDark = document.body.classList.contains('dark');
    const textColor = isDark ? '#f9fafb' : '#1f2937';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    
    const chart = Chart.getChart('latencyChart');
    if (chart) {
      chart.options.scales.y.ticks.color = textColor;
      chart.options.scales.x.ticks.color = textColor;
      chart.options.scales.y.title.color = textColor;
      chart.options.scales.y.grid.color = gridColor;
      chart.options.plugins.legend.labels.color = textColor;
      
      chart.update();
    }
  }

  loadData();
</script>
</body>
</html>
